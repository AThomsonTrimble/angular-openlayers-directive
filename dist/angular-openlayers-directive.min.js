/**!
 * The MIT License
 *
 * Copyright (c) 2013 the angular-leaflet-directive Team, http://tombatossals.github.io/angular-leaflet-directive
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 * angular-google-maps
 * https://github.com/tombatossals/angular-leaflet-directive
 *
 * @authors https://github.com/tombatossals/angular-leaflet-directive/graphs/contributors
 */

/*! angular-openlayers-directive 31-10-2014 */
!function(){"use strict";angular.module("openlayers-directive",[]).directive("openlayers",["$log","$q","olHelpers","olMapDefaults","olData",function(a,b,c,d,e){var f;return{restrict:"EA",replace:!0,scope:{center:"=center",defaults:"=defaults",layers:"=layers",markers:"=markers",events:"=events"},transclude:!0,template:'<div class="angular-openlayers-map"><div ng-transclude></div></div>',controller:["$scope",function(a){f=b.defer(),this.getMap=function(){return f.promise},this.getOpenlayersScope=function(){return a}}],link:function(a,b,g){var h=c.isDefined,i=c.createLayer,j=c.createProjection,k=c.setEvents,l=d.setDefaults(a.defaults,g.id);h(g.width)&&(isNaN(g.width)?b.css("width",g.width):b.css("width",g.width+"px")),h(g.height)&&(isNaN(g.height)?b.css("height",g.height):b.css("height",g.height+"px"));var m=ol.control.defaults(l.controls),n=ol.interaction.defaults(l.interactions),o=j(l.view.projection),p=new ol.Map({target:b[0],controls:m,interactions:n,renderer:l.renderer,view:new ol.View({projection:o,maxZoom:l.view.maxZoom,minZoom:l.view.minZoom})});if(!h(g.layers)){var q=i(l.layers.main);p.addLayer(q)}if(h(g.events)||k(l.events,p,a),!h(g.center)){var r=p.getView();r.setCenter([l.center.lon,l.center.lat]),r.setZoom(l.center.zoom)}e.setMap(p,g.id),f.resolve(p)}}}]),angular.module("openlayers-directive").directive("center",["$log","$location","olMapDefaults","olHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"openlayers",link:function(e,f,g,h){var i=d.safeApply,j=d.isValidCenter,k=d.isDefined,l=d.isArray,m=d.isNumber,n=d.isSameCenterOnMap,o=h.getOpenlayersScope();h.getMap().then(function(e){var f=c.getDefaults(g.id),h=o.center,p=e.getView(),q=function(a,b,c){if(c.projection===b)a.setCenter([c.lon,c.lat]);else{var d=[c.lon,c.lat];a.setCenter(ol.proj.transform(d,b,c.projection))}};if(h.projection||(h.projection="pixel"!==f.view.projection?f.center.projection:f.view.projection),-1!==g.center.search("-"))return a.error('[AngularJS - Openlayers] The "center" variable can\'t use a "-" on his key name: "'+g.center+'".'),void q(p,f.view.projection,f.center);j(h)||(a.warn("[AngularJS - Openlayers] invalid 'center'"),h=angular.copy(f.center)),m(h.zoom)||(h.zoom=1),q(p,f.view.projection,h),p.setZoom(h.zoom);var r;if(h.centerUrlHash===!0){var s=function(){var a,c=b.search();if(k(c.c)){var d=c.c.split(":");3===d.length&&(a={lat:parseFloat(d[0]),lon:parseFloat(d[1]),zoom:parseInt(d[2],10)})}return a};r=s(),o.$on("$locationChangeSuccess",function(){r=s()})}var t;o.$watch("center",function(b){if(k(r)){var c=s();n(c,e)||(b.lat=r.lat,b.lon=r.lon,b.zoom=r.zoom),r=void 0}if(b.projection||(b.projection=f.center.projection),b.autodiscover)return t||(t=new ol.Geolocation({projection:ol.proj.get(f.view.projection)}),t.on("change",function(){if(b.autodiscover){var a=t.getPosition();i(o,function(b){b.center.lat=a[1],b.center.lon=a[0],b.center.zoom=12,b.center.autodiscover=!1,t.setTracking(!1)})}})),void t.setTracking(!0);j(b)||(a.warn("[AngularJS - Openlayers] invalid 'center'"),b=f.center);var d=p.getCenter();if(d){if("pixel"===f.view.projection)return void p.setCenter(b.coord);var g=ol.proj.transform(d,b.projection,f.view.projection);(g[1]!==b.lat||g[0]!==b.lon)&&q(p,f.view.projection,b)}p.getZoom()!==b.zoom&&p.setZoom(b.zoom)},!0),p.on("change:resolution",function(){i(o,function(a){if(a.center.zoom=p.getZoom(),d.notifyCenterUrlHashChanged(o,a.center,b.search()),l(a.center.bounds)){var c=p.calculateExtent(e.getSize()),g=a.center.projection,h=f.view.projection;a.center.bounds=ol.proj.transform(c,g,h)}})}),p.on("change:center",function(){i(o,function(a){var c=e.getView().getCenter();if("pixel"===f.view.projection)return void(a.center.coord=c);var g=ol.proj.transform(c,a.center.projection,f.view.projection);if(a.center&&(a.center.lat=g[1],a.center.lon=g[0],d.notifyCenterUrlHashChanged(o,a.center,b.search()),l(a.center.bounds))){var h=p.calculateExtent(e.getSize()),i=a.center.projection,j=f.view.projection;a.center.bounds=ol.proj.transform(h,i,j)}})})})}}}]),angular.module("openlayers-directive").directive("layers",["$log","$q","olData","olMapDefaults","olHelpers",function(a,b,c,d,e){var f;return{restrict:"A",scope:!1,replace:!1,require:"openlayers",controller:function(){f=b.defer(),this.getLayers=function(){return f.promise}},link:function(b,g,h,i){var j=e.isDefined,k=e.equals,l={},m=i.getOpenlayersScope(),n=e.createLayer,o=e.createStyle;i.getMap().then(function(b){var e=d.getDefaults(h.id),g=b.getView().getProjection();m.$watch("layers",function(c,d){var f,h=c[Object.keys(c)[0]];j(h)&&j(h.source)&&j(h.source.type)||(a.warn("[AngularJS - OpenLayers] At least one layer has to be defined."),c=angular.copy(e.layers));for(f in l)if(h=l[f],!c.hasOwnProperty(f)){var i=b.getLayers();for(var m in i)i[m]===h&&b.removeLayer(c);delete l[f]}for(f in c){h=c[f];var p,q;if(l.hasOwnProperty(f)){h=c[f];var r=d[f];p=l[f],j(r)&&!k(h,r)&&(k(h.source,r.source)||(b.removeLayer(p),delete l[f],p=n(h,g),j(p)&&(l[f]=p,b.addLayer(p))),h.opacity&&h.opacity!==r.opacity&&p.setOpacity(h.opacity),h.style&&!k(h.style,r.style)&&(q=angular.isFunction(h.style)?h.style:o(h.style),p.setStyle(q)))}else p=n(c[f],g),j(p)&&(l[f]=p,b.addLayer(p),h.opacity&&p.setOpacity(h.opacity),h.style&&(q=angular.isFunction(h.style)?h.style:o(h.style),p.setStyle(q)))}},!0),f.resolve(l),c.setLayers(l,h.id)})}}}]),angular.module("openlayers-directive").directive("events",["$log","$q","olData","olMapDefaults","olHelpers",function(a,b,c,d,e){return{restrict:"A",scope:!1,replace:!1,require:["openlayers","layers"],link:function(a,c,d,f){var g=e.setEvents,h=e.isDefined,i=f[0],j=i.getOpenlayersScope();i.getMap().then(function(a){var c;c=h(f[1])?f[1].getLayers:function(){var a=b.defer();return a.resolve(),a.promise},c().then(function(b){j.$watch("events",function(c){g(c,a,j,b)})})})}}}]),angular.module("openlayers-directive").directive("markers",["$log","$q","olData","olMapDefaults","olHelpers",function(a,b,c,d,e){return{restrict:"A",scope:!1,replace:!1,require:["openlayers","?layers"],link:function(d,f,g,h){var i=h[0],j=e.isDefined,k=i.getOpenlayersScope(),l=e.createMarkerLayer,m=e.createMarker;i.getMap().then(function(d){var e,f={};e=j(h[1])?h[1].getLayers:function(){var a=b.defer();return a.resolve(),a.promise},e().then(function(){c.setMarkers(f,g.id);var b=l();k.$watch("markers",function(c){for(var e in f)j(f)&&j(c[e])||(b.getSource().removeFeature(f[e]),delete f[e]);for(var g in c)if(-1===g.search("-")){if(!j(f[g])){var h=c[g],i=m(h);if(!j(i)){a.error("[AngularJS - Openlayers] Received invalid data on the marker "+g+".");continue}f[g]=i,b.getSource().addFeature(i)}}else a.error('[AngularJS - Openlayers] The marker can\'t use a "-" on his key name: "'+g+'".');d.addLayer(b)},!0)})})}}}]),angular.module("openlayers-directive").service("olData",["$log","$q","olHelpers",function(a,b,c){var d=c.obtainEffectiveMapId,e={},f={},g={},h=function(a,b){var c=d(a,b);a[c].resolvedDefer=!0},i=function(a,c){var e,f=d(a,c);return angular.isDefined(a[f])&&a[f].resolvedDefer!==!0?e=a[f].defer:(e=b.defer(),a[f]={defer:e,resolvedDefer:!1}),e},j=function(a,b){var c,e=d(a,b);return c=angular.isDefined(a[e])&&a[e].resolvedDefer!==!1?a[e].defer:i(a,b)};this.setMap=function(a,b){var c=i(e,b);c.resolve(a),h(e,b)},this.getMap=function(a){var b=j(e,a);return b.promise},this.getLayers=function(a){var b=j(f,a);return b.promise},this.setLayers=function(a,b){var c=i(f,b);c.resolve(a),h(f,b)},this.getMarkers=function(a){var b=j(g,a);return b.promise},this.setMarkers=function(a,b){var c=i(g,b);c.resolve(a),h(g,b)}}]),angular.module("openlayers-directive").factory("olHelpers",["$q","$log",function(a,b){var c=function(a){return angular.isDefined(a)},d=["Road","Aerial","AerialWithLabels","collinsBart","ordnanceSurvey"],e=["osm","sat","hyb"],f=function(a){var b,c;return a.fill&&(b=new ol.style.Fill({color:a.fill.color})),a.stroke&&(c=new ol.style.Stroke({color:a.stroke.color,width:a.stroke.width})),new ol.style.Style({fill:b,stroke:c})},g=function(a){if(a.type)return a.type;switch(a.source.type){case"ImageStatic":return"Image";case"GeoJSON":return"Vector";case"TopoJSON":return"Vector";default:return"Tile"}},h=function(a){var b;switch(a){case"EPSG:3857":b=new ol.proj.get(a);break;case"pixel":b=new ol.proj.Projection({code:"pixel",units:"pixels",extent:[0,0,4500,2234]})}return b},i=function(a){return-1!==["watercolor","terrain","toner"].indexOf(a)},j=function(a,c){var f;switch(a.type){case"OSM":f=a.attribution?new ol.source.OSM({attributions:[new ol.Attribution({html:a.attribution}),ol.source.OSM.DATA_ATTRIBUTION]}):new ol.source.OSM,a.url&&f.setUrl(a.url);break;case"BingMaps":if(!a.key)return void b.error("[AngularJS - Openlayers] - You need an API key to show the Bing Maps.");f=new ol.source.BingMaps({key:a.key,imagerySet:a.imagerySet?a.imagerySet:d[0]});break;case"MapQuest":if(!a.layer||-1===e.indexOf(a.layer))return void b.error("[AngularJS - Openlayers] - MapQuest layers needs a valid 'layer' property.");f=new ol.source.MapQuest({layer:a.layer});break;case"GeoJSON":if(!a.features&&!a.url)return void b.error("[AngularJS - Openlayers] - You need a GeoJSON features property to add a GeoJSON layer.");f=new ol.source.GeoJSON(a.url?{projection:c,url:a.url}:a.geojson);break;case"TopoJSON":if(!a.features&&!a.url)return void b.error("[AngularJS - Openlayers] - You need a TopoJSON features property to add a GeoJSON layer.");f=new ol.source.TopoJSON(a.url?{projection:c,url:a.url}:a.topojson);break;case"TileJSON":f=new ol.source.TileJSON({url:a.url,crossOrigin:"anonymous"});break;case"Stamen":if(!a.layer||!i(a.layer))return void b.error("[AngularJS - Openlayers] - You need a valid Stamen layer.");f=new ol.source.Stamen({layer:a.layer});break;case"ImageStatic":if(!a.url||!angular.isArray(a.imageSize)||2!==a.imageSize.length)return void b.error("[AngularJS - Openlayers] - You need a image URL to create a ImageStatic layer.");f=new ol.source.ImageStatic({url:a.url,imageSize:a.imageSize,projection:c,imageExtent:c.getExtent()})}return f};return{isDefined:c,isNumber:function(a){return angular.isNumber(a)},createProjection:h,isDefinedAndNotNull:function(a){return angular.isDefined(a)&&null!==a},isString:function(a){return angular.isString(a)},isArray:function(a){return angular.isArray(a)},isObject:function(a){return angular.isObject(a)},equals:function(a,b){return angular.equals(a,b)},isValidCenter:function(a){return angular.isDefined(a)&&(angular.isNumber(a.lat)&&angular.isNumber(a.lon)||angular.isArray(a.coord)&&2===a.coord.length&&angular.isNumber(a.coord[0])&&angular.isNumber(a.coord[1])||angular.isArray(a.bounds)&&4===a.bounds.length&&angular.isNumber(a.bounds[0])&&angular.isNumber(a.bounds[1])&&angular.isNumber(a.bounds[1])&&angular.isNumber(a.bounds[2]))},safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?a.$eval(b):a.$apply(b)},isSameCenterOnMap:function(a,b){var c=b.getView().getCenter(),d=b.getView().getZoom();return c[1].toFixed(4)===a.lat.toFixed(4)&&c[1].toFixed(4)===a.lon.toFixed(4)&&d===a.zoom?!0:!1},obtainEffectiveMapId:function(a,c){var d,e;if(angular.isDefined(c))d=c;else if(1===Object.keys(a).length)for(e in a)a.hasOwnProperty(e)&&(d=e);else 0===Object.keys(a).length?d="main":b.error("[AngularJS - Openlayers] - You have more than 1 map on the DOM, you must provide the map ID to the olData.getXXX call");return d},generateUniqueUID:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},createStyle:f,setEvents:function(a,b,d,e){c(a)&&c(e)&&c(a.layers)&&angular.isArray(a.layers.vector)&&angular.forEach(a.layers.vector,function(a){angular.element(b.getViewport()).on(a,function(c){var e=b.getEventPixel(c),f=b.forEachFeatureAtPixel(e,function(a){return a});d.$emit("openlayers.geojson."+a,f)})})},detectLayerType:g,createLayer:function(a,b){var c,d=g(a),e=j(a.source,b);if(e){switch(d){case"Image":c=new ol.layer.Image({source:e});break;case"Tile":c=new ol.layer.Tile({source:e});break;case"Vector":var h;a.style&&(h=f(a.style)),c=new ol.layer.Vector({source:e,style:h})}return angular.isNumber(a.opacity)&&c.setOpacity(a.opacity),c}},createMarkerLayer:function(){return new ol.layer.Vector({source:new ol.source.Vector})},notifyCenterUrlHashChanged:function(a,b,d){if(b.centerUrlHash){var e=b.lat.toFixed(4)+":"+b.lon.toFixed(4)+":"+b.zoom;c(d.c)&&d.c===e||a.$emit("centerUrlHash",e)}},createMarker:function(a){if(!c(a))return void b.error("[AngularJS - OpenLayers] The marker definition is not valid.");var d,e=new ol.geom.Point([a.lon,a.lat]).transform("EPSG:4326","EPSG:3857"),f=new ol.Feature({geometry:e});if(!a.style){var g="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAApCAYAAADAk4LOAAAGmklEQVRYw7VXeUyTZxjvNnfELFuyIzOabermMZEeQC/OclkO49CpOHXOLJl/CAURuYbQi3KLgEhbrhZ1aDwmaoGqKII6odATmH/scDFbdC7LvFqOCc+e95s2VG50X/LLm/f4/Z7neY/ne18aANCmAr5E/xZf1uDOkTcGcWR6hl9247tT5U7Y6SNvWsKT63P58qbfeLJG8M5qcgTknrvvrdDbsT7Ml+tv82X6vVxJE33aRmgSyYtcWVMqX97Yv2JvW39UhRE2HuyBL+t+gK1116ly06EeWFNlAmHxlQE0OMiV6mQCScusKRlhS3QLeVJdl1+23h5dY4FNB3thrbYboqptEFlphTC1hSpJnbRvxP4NWgsE5Jyz86QNNi/5qSUTGuFk1gu54tN9wuK2wc3o+Wc13RCmsoBwEqzGcZsxsvCSy/9wJKf7UWf1mEY8JWfewc67UUoDbDjQC+FqK4QqLVMGGR9d2wurKzqBk3nqIT/9zLxRRjgZ9bqQgub+DdoeCC03Q8j+0QhFhBHR/eP3U/zCln7Uu+hihJ1+bBNffLIvmkyP0gpBZWYXhKussK6mBz5HT6M1Nqpcp+mBCPXosYQfrekGvrjewd59/GvKCE7TbK/04/ZV5QZYVWmDwH1mF3xa2Q3ra3DBC5vBT1oP7PTj4C0+CcL8c7C2CtejqhuCnuIQHaKHzvcRfZpnylFfXsYJx3pNLwhKzRAwAhEqG0SpusBHfAKkxw3w4627MPhoCH798z7s0ZnBJ/MEJbZSbXPhER2ih7p2ok/zSj2cEJDd4CAe+5WYnBCgR2uruyEw6zRoW6/DWJ/OeAP8pd/BGtzOZKpG8oke0SX6GMmRk6GFlyAc59K32OTEinILRJRchah8HQwND8N435Z9Z0FY1EqtxUg+0SO6RJ/mmXz4VuS+DpxXC3gXmZwIL7dBSH4zKE50wESf8qwVgrP1EIlTO5JP9Igu0aexdh28F1lmAEGJGfh7jE6ElyM5Rw/FDcYJjWhbeiBYoYNIpc2FT/SILivp0F1ipDWk4BIEo2VuodEJUifhbiltnNBIXPUFCMpthtAyqws/BPlEF/VbaIxErdxPphsU7rcCp8DohC+GvBIPJS/tW2jtvTmmAeuNO8BNOYQeG8G/2OzCJ3q+soYB5i6NhMaKr17FSal7GIHheuV3uSCY8qYVuEm1cOzqdWr7ku/R0BDoTT+DT+ohCM6/CCvKLKO4RI+dXPeAuaMqksaKrZ7L3FE5FIFbkIceeOZ2OcHO6wIhTkNo0ffgjRGxEqogXHYUPHfWAC/lADpwGcLRY3aeK4/oRGCKYcZXPVoeX/kelVYY8dUGf8V5EBRbgJXT5QIPhP9ePJi428JKOiEYhYXFBqou2Guh+p/mEB1/RfMw6rY7cxcjTrneI1FrDyuzUSRm9miwEJx8E/gUmqlyvHGkneiwErR21F3tNOK5Tf0yXaT+O7DgCvALTUBXdM4YhC/IawPU+2PduqMvuaR6eoxSwUk75ggqsYJ7VicsnwGIkZBSXKOUww73WGXyqP+J2/b9c+gi1YAg/xpwck3gJuucNrh5JvDPvQr0WFXf0piyt8f8/WI0hV4pRxxkQZdJDfDJNOAmM0Ag8jyT6hz0WGXWuP94Yh2jcfjmXAGvHCMslRimDHYuHuDsy2QtHuIavznhbYURq5R57KpzBBRZKPJi8eQg48h4j8SDdowifdIrEVdU+gbO6QNvRRt4ZBthUaZhUnjlYObNagV3keoeru3rU7rcuceqU1mJBxy+BWZYlNEBH+0eH4vRiB+OYybU2hnblYlTvkHinM4m54YnxSyaZYSF6R3jwgP7udKLGIX6r/lbNa9N6y5MFynjWDtrHd75ZvTYAPO/6RgF0k76mQla3FGq7dO+cH8sKn0Vo7nDllwAhqwLPkxrHwWmHJOo+AKJ4rab5OgrM7rVu8eWb2Pu0Dh4eDgXoOfvp7Y7QeqknRmvcTBEyq9m/HQQSCSz6LHq3z0yzsNySRfMS253wl2KyRDbcZPcfJKjZmSEOjcxyi+Y8dUOtsIEH6R2wNykdqrkYJ0RV92H0W58pkfQk7cKevsLK10Py8SdMGfXNXATY+pPbyJR/ET6n9nIfztNtZYRV9XniQu9IA2vOVgy4ir7GCLVmmd+zjkH0eAF9Po6K61pmCXHxU5rHMYd1ftc3owjwRSVRzLjKvqZEty6cRUD7jGqiOdu5HG6MdHjNcNYGqfDm5YRzLBBCCDl/2bk8a8gdbqcfwECu62Fg/HrggAAAABJRU5ErkJggg==";d=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:.9,src:g})})}return f.setStyle(d),f}}}]),angular.module("openlayers-directive").factory("olMapDefaults",["$q","olHelpers",function(a,b){var c=function(){return{interactions:{dragRotate:!0,doubleClickZoom:!0,dragPan:!0,pinchRotate:!0,pinchZoom:!0,keyboardPan:!0,keyboardZoom:!0,mouseWheelZoom:!0,dragZoom:!0},view:{projection:"EPSG:4326",minZoom:void 0,maxZoom:void 0},layers:{main:{type:"Tile",source:{type:"OSM"}}},center:{lat:0,lon:0,zoom:1,autodiscover:!1,bounds:[],centerUrlHash:!1,projection:"EPSG:3857"},controls:{attribution:!0,rotate:!1,zoom:!0},events:{map:["click"]},renderer:"canvas"}},d=b.isDefined,e=b.obtainEffectiveMapId,f={};return{getDefaults:function(a){var b=e(f,a);return f[b]},setDefaults:function(a,b){var g=c();d(a)&&(d(a.layers)&&(g.layers=angular.copy(a.layers)),d(a.controls)&&(g.controls=angular.copy(a.controls)),d(a.interactions)&&(g.interactions=angular.copy(a.interactions)),d(a.renderer)&&(g.renderer=a.renderer),d(a.view)&&(g.view.maxZoom=a.view.maxZoom||g.view.maxZoom,g.view.minZoom=a.view.minZoom||g.view.minZoom,g.view.projection=a.view.projection||g.view.projection));var h=e(f,b);return f[h]=g,g}}}])}();